\"\"\"\nTests for User model and related functionality.\n\"\"\"\nimport pytest\nfrom pydantic import ValidationError\n\nfrom app.models.user import User\nfrom app.schemas.user import UserCreate, UserResponse, UserInDB\nfrom app.utils.security import hash_password, verify_password\n\n\nclass TestUserModel:\n    \"\"\"Tests for the User SQLAlchemy model.\"\"\"\n\n    def test_user_model_has_required_fields(self):\n        \"\"\"Test that User model has all required fields.\"\"\"\n        assert hasattr(User, 'id')\n        assert hasattr(User, 'username')\n        assert hasattr(User, 'password_hash')\n        assert hasattr(User, 'created_at')\n        assert hasattr(User, 'updated_at')\n\n    def test_user_model_tablename(self):\n        \"\"\"Test that User model uses correct table name.\"\"\"\n        assert User.__tablename__ == 'users'\n\n    def test_user_repr(self):\n        \"\"\"Test User model string representation.\"\"\"\n        user = User(id=1, username='testuser', password_hash='hash')\n        assert 'testuser' in repr(user)\n        assert '1' in repr(user)\n\n\nclass TestUserSchemas:\n    \"\"\"Tests for Pydantic User schemas.\"\"\"\n\n    def test_user_create_valid(self):\n        \"\"\"Test UserCreate with valid data.\"\"\"\n        user = UserCreate(username='testuser', password='password123')\n        assert user.username == 'testuser'\n        assert user.password == 'password123'\n\n    def test_user_create_username_lowercase(self):\n        \"\"\"Test UserCreate converts username to lowercase.\"\"\"\n        user = UserCreate(username='TestUser', password='password123')\n        assert user.username == 'testuser'\n\n    def test_user_create_username_too_short(self):\n        \"\"\"Test UserCreate rejects username that is too short.\"\"\"\n        with pytest.raises(ValidationError) as exc_info:\n            UserCreate(username='ab', password='password123')\n        assert 'username' in str(exc_info.value).lower()\n\n    def test_user_create_username_too_long(self):\n        \"\"\"Test UserCreate rejects username that is too long.\"\"\"\n        with pytest.raises(ValidationError) as exc_info:\n            UserCreate(username='a' * 51, password='password123')\n        assert 'username' in str(exc_info.value).lower()\n\n    def test_user_create_username_invalid_characters(self):\n        \"\"\"Test UserCreate rejects username with invalid characters.\"\"\"\n        with pytest.raises(ValidationError) as exc_info:\n            UserCreate(username='test@user', password='password123')\n        assert 'alphanumeric' in str(exc_info.value).lower() or 'username' in str(exc_info.value).lower()\n\n    def test_user_create_username_with_underscore(self):\n        \"\"\"Test UserCreate accepts username with underscore.\"\"\"\n        user = UserCreate(username='test_user', password='password123')\n        assert user.username == 'test_user'\n\n    def test_user_create_password_too_short(self):\n        \"\"\"Test UserCreate rejects password that is too short.\"\"\"\n        with pytest.raises(ValidationError) as exc_info:\n            UserCreate(username='testuser', password='short')\n        assert 'password' in str(exc_info.value).lower()\n\n    def test_user_response_excludes_password(self):\n        \"\"\"Test UserResponse does not include password field.\"\"\"\n        # UserResponse should not have password_hash field\n        assert 'password' not in UserResponse.model_fields\n        assert 'password_hash' not in UserResponse.model_fields\n\n    def test_user_in_db_includes_password_hash(self):\n        \"\"\"Test UserInDB includes password_hash field.\"\"\"\n        assert 'password_hash' in UserInDB.model_fields\n\n\nclass TestPasswordHashing:\n    \"\"\"Tests for password hashing utilities.\"\"\"\n\n    def test_hash_password_returns_hash(self):\n        \"\"\"Test that hash_password returns a hash.\"\"\"\n        password = 'testpassword123'\n        hashed = hash_password(password)\n        assert hashed != password\n        assert len(hashed) >= 60  # bcrypt hashes are at least 60 chars\n\n    def test_hash_password_different_hashes(self):\n        \"\"\"Test that same password produces different hashes (salting).\"\"\"\n        password = 'testpassword123'\n        hash1 = hash_password(password)\n        hash2 = hash_password(password)\n        assert hash1 != hash2  # Different salt each time\n\n    def test_verify_password_correct(self):\n        \"\"\"Test that verify_password returns True for correct password.\"\"\"\n        password = 'testpassword123'\n        hashed = hash_password(password)\n        assert verify_password(password, hashed) is True\n\n    def test_verify_password_incorrect(self):\n        \"\"\"Test that verify_password returns False for incorrect password.\"\"\"\n        password = 'testpassword123'\n        hashed = hash_password(password)\n        assert verify_password('wrongpassword', hashed) is False\n\n    def test_bcrypt_hash_format(self):\n        \"\"\"Test that hash is in bcrypt format.\"\"\"\n        password = 'testpassword123'\n        hashed = hash_password(password)\n        # bcrypt hashes start with $2b$ or $2a$\n        assert hashed.startswith('$2') \n